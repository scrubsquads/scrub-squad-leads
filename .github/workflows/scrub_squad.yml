name: Scrub Squad Daily Leads

# ---------------------------------------------------------------------------
# Schedule
# ---------------------------------------------------------------------------
# Cron fires at 13:00 UTC every day.
#   • Nov – Mar (EST):  13:00 UTC = 8:00 AM ET   ✓
#   • Mar – Nov (EDT):  13:00 UTC = 9:00 AM ET   (1-hour DST drift)
#
# GitHub Actions has no timezone-aware cron.  The 1-hour seasonal shift
# is a platform limitation.  Do not investigate it as a bug.
#
# Manual trigger is available via "Run workflow" in the GitHub Actions UI.
# Use it for testing or to kick off an ad-hoc run at any time.
# ---------------------------------------------------------------------------
on:
  schedule:
    - cron: '0 13 * * *'
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------------
      # 1. Checkout source code
      # ---------------------------------------------------------------
      - uses: actions/checkout@v4

      # ---------------------------------------------------------------
      # 2. Python 3.11
      # ---------------------------------------------------------------
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ---------------------------------------------------------------
      # 3. Install dependencies
      # ---------------------------------------------------------------
      - name: Install dependencies
        run: pip install -r requirements.txt

      # ---------------------------------------------------------------
      # 4. Run the pipeline
      #    Secrets are injected as env vars — nothing hits the filesystem.
      #    Exit code != 0 on PARTIAL_FAILURE or FAILED → job turns red
      #    and GitHub sends a failure notification email.
      # ---------------------------------------------------------------
      - name: Run lead pipeline
        env:
          OUTSCRAPER_API_KEY:            ${{ secrets.OUTSCRAPER_API_KEY }}
          GOOGLE_SERVICE_ACCOUNT_JSON:   ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_SHEET_ID:               ${{ secrets.GOOGLE_SHEET_ID }}
        run: python tools/run_pipeline.py

  # -----------------------------------------------------------------
  # Job 2: Enrich new leads with Apollo.io contacts
  # Runs after scrape completes — only processes un-enriched leads.
  # Uses batch-size 50 to handle daily volume without burning credits.
  # -----------------------------------------------------------------
  enrich:
    needs: scrape
    runs-on: ubuntu-latest
    if: always() && needs.scrape.result != 'cancelled'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run contact enrichment
        env:
          APOLLO_API_KEY:               ${{ secrets.APOLLO_API_KEY }}
          GOOGLE_SERVICE_ACCOUNT_JSON:  ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_SHEET_ID:              ${{ secrets.GOOGLE_SHEET_ID }}
        run: python tools/run_enrichment.py --batch-size 50

